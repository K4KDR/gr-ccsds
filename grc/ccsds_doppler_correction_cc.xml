<?xml version="1.0"?>
<block>
  <name>Doppler correction from elements (C++)</name>
  <key>ccsds_doppler_correction_cc</key>
  <category>[ccsds]</category>
  <import>import ccsds</import>
  <make>ccsds.doppler_correction_cc($tles, $sampl_rate, $t_update, $frequency, $lla, $blocksize)</make>
  <param>
    <name>TLE lines</name>
    <key>tles</key>
    <type>raw</type>
  </param>
  <param>
    <name>GS location</name>
    <key>lla</key>
    <value>(48.266278, 11.668361, 545.0)</value>
    <type>raw</type>
  </param>
  <param>
    <name>Centre frequency</name>
    <key>frequency</key>
    <type>real</type>
  </param>
  <param>
    <name>Sampling rate</name>
    <key>sampl_rate</key>
    <value>samp_rate</value>
    <type>real</type>
  </param>
  <param>
    <name>Update time</name>
    <key>t_update</key>
    <value>0.1</value>
    <type>real</type>
  </param>
  <param>
    <name>Blocksize</name>
    <key>blocksize</key>
    <value>2048</value>
    <type>real</type>
  </param>

  <sink>
    <name>in</name>
    <type>complex</type>
  </sink>

  <source>
    <name>out</name>
    <type>complex</type>
  </source>
  
  <doc>
Shift input signal in order to compensate an anticipated Doppler shift on the given centre frequency as computed by the given TLE and the given ground station location.

The Doppler shift correction is performed in a phase-continuous manner. The Doppler shift is computed with
f_d(t) = f_0/c range_rate(t)
where f_0 is the centre frequency, c is the speed of light and range_rate is the relative velocity of the satellite towards the ground station (in an ECI frame) which is obtained by taking the time derivative of the range (distance) between the satellite and the ground station.

The phase of each sample is offset by 2pi* \int_0^t f_d(\tau) d\tau = 2pi*f_0/c int_0^t range_rate(\tau) d\tau = 2pi*f_0/c (range(t) - range(0))
range(0) is the computed range at the start of the block and range(t) is the computed range for the sample that corresponds to time t.

The ranges are computed from the TLE every t_u seconds. The ranges for the samples in between are computed by linear interpolation between the two neighbouring time points for which a range has been computed.

The blocks parameters are:
  TLE lines: Array with the string entries from the TLE file. The array must have a length of two or three (if the satellite name is given). The second to last element must start with a '1' and have at least 69 characters. The last element must start with a '2' and have at least 69 characters.

  GS location: Location of the ground station as a tuple of length 3 containing the latitude in degrees (positive for northern hemisphere), longitude in degrees (positive for locations east of Grenwich) and altitude in metre (above the WGS-72 ellipsoid).

  Centre frequency: Nominal frequency f_0 of the signal to scale the Doppler shift correction.

  Sampling rate: The sampling rate of the input (and output) signal in Hz. The inverse of this number gives the time in seconds between two samples.
  
  Update time: Compute a new range from the orbital elements every update_time seconds.
  
  Block length: Process the samples in blocks of this length. A higher block length increases the computation efficiency, but also increases the memory requirements (16*block_len Bytes) and the output latency (block_len/samp_rate seconds).
  </doc>
</block>
